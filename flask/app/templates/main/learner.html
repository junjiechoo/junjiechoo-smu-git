{% extends "layout.html" %}

    <h2>{%trans%}Learner's Page{%endtrans%}</h2>

{% block content %}
    <!-- data population for enrolment -->
    <h5>Wel Fking Come {{learner[0].getLearnerName()}}</h5>

    {% if enteredEnrolment %}
        <h3>Enrolment</h3>
        {% for i in enrolment %}
            {% for j in i.getCompletedCourses('L001') %}
                <p>{{j}}</p>
            {% endfor %}
            <p>{{i.getApprovalStatus('E001')}}</p>
        {% endfor %}
    {% endif %}

    <!-- data population for courses -->
    {% if enteredCourses %}
        <h3>Courses</h3>
        <table>
            <tr>
                <th>CourseID</th>
                <th>Course Name</th>
                <th>Prerequisites</th>
                <th>Apply</th>
            </tr>
        
        {% for i in courses %}
            <tr>
                <td>{{i.displayCourseId()}}</td>
                <td>{{i.displayCourseName()}}</td>
                <td>
                    {% if i.getPrerequisite() == None %}
                        No Prerequisites
                    {% else %}
                        {% for j in i.getPrerequisite() %}
                            <p>{{j}}</p>
                        {% endfor %}
                    {% endif %}
                    
                </td>
                <td>
                    {% if i.getPrerequisite() == None %}
                        <p>You are Eligible</p>
                        <!-- this one passes a string correctly to flask-->
                        <button onclick="applyCourse('{{i.displayCourseId()}}', '{{learner[0].getLearnerId()}}')">Apply!</button>
                    {% else %}
                        <button onclick="checkEligibility({{i.getPrerequisite()}}, '{{i.displayCourseId()}}', {{learner[0].getCoursesTaken()}})">Check Eligibility</button>
                        <div id="{{i.displayCourseId()}}"></div>
                        
                        <!-- why this third input cannot work fk coding -->
                        <!-- <script>
                            checkEligibility({{i.getPrerequisite()}}, '{{i.displayCourseId()}}', {{learner[0].getCoursesTaken()}});
                        </script> -->
                        
                    {% endif %}
                    
                </td>
            </tr>   
        {% endfor %}         
        </table>
    {% endif %}

    <script>
        // haven't put in learnerId
        function applyCourse(courseId){
            var userInfo = courseId;
            console.log(courseId);
            console.log('applying for course now');
            const request = new XMLHttpRequest()
            request.open("GET", `/learner/courses/${userInfo}`);
            request.onload = () => {
                const flaskMessage = request.responseText;
                console.log(flaskMessage);
            }
            request.send();
        }

        function checkEligibility(prereq, courseId, coursesCompleted){
            var remainingCourses = '';
            for (course of coursesCompleted){
                    var index = prereq.indexOf(course);
                    if (index > -1){
                        prereq.splice(index,1);
                    }
            }
                
                if (prereq.length > 0){
                    for (course of prereq){
                        console.log(course);
                        remainingCourses += course + ", ";
                    }
                    remainingCourses = remainingCourses.slice(0,-2);
                    document.getElementById(courseId).innerHTML = "you need the following courses: " + remainingCourses;
                } else{
                    // but this one pass a whole div tag to flask
                    document.getElementById(courseId).innerHTML = "You Are Eligible!" + `<button onclick="applyCourse(${courseId})">Apply</button>`;
                }
        }
    </script>
{% endblock %}

